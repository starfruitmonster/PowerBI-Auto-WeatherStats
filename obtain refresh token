import requests
import webbrowser
import urllib.parse

# === CONFIG ===
client_id = "YOUR CLIENT ID"
client_secret = "CLIENT SECRET"
redirect_uri = "http://localhost:53682/"
tenant = "common"

# === STEP 1: Create Authorization URL ===
auth_url = f"https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize"
params = {
    "client_id": client_id,
    "response_type": "code",
    "redirect_uri": redirect_uri,
    "response_mode": "query",
    "scope": "https://analysis.windows.net/powerbi/api/.default offline_access openid"
}
full_auth_url = f"{auth_url}?{urllib.parse.urlencode(params)}"

print("Open this URL in your browser and log in:")
print(full_auth_url)
webbrowser.open(full_auth_url)

# === STEP 2: Paste Redirect URL After Login ===
redirect_response = input("\nAfter logging in, paste the FULL redirected URL here:\n> ")

parsed_url = urllib.parse.urlparse(redirect_response)
code = urllib.parse.parse_qs(parsed_url.query).get("code", [None])[0]

if not code:
    print("Authorization code not found. Make sure you pasted the full URL correctly.")
    exit(1)

# === STEP 3: Exchange Code for Tokens ===
token_url = f"https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token"
token_data = {
    "client_id": client_id,
    "client_secret": client_secret,
    "grant_type": "authorization_code",
    "code": code,
    "redirect_uri": redirect_uri,
    "scope": "https://analysis.windows.net/powerbi/api/.default offline_access openid"
}

response = requests.post(token_url, data=token_data)
tokens = response.json()

# === STEP 4: Save Tokens to File ===
if "access_token" in tokens:
    print("\nSuccessfully received tokens. Saving to tokens.txt...")

    with open("tokens.txt", "w") as f:
        f.write("Access Token:\n")
        f.write(tokens["access_token"] + "\n\n")
        f.write("Refresh Token:\n")
        f.write(tokens["refresh_token"] + "\n\n")
        f.write("Expires In (seconds):\n")
        f.write(str(tokens["expires_in"]) + "\n")

    print("Saved successfully to tokens.txt.")
else:
    print("Token exchange failed:")
    print(tokens)
